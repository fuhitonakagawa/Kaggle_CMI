以下、アップデート版（IMU+ToF+Thermal、モダリティ・ドロップアウト対応）の**包括レビュー**です。
「何の特徴量を、どの系統（IMU/ToF/Thermal/クロス）から使っているか」→「動作確認と堅牢性」→「潜在的な不具合・改善点（具体的修正コード含む）」の順にまとめます。

---

## 1) 使っている特徴量と系統（どのセンサー由来か）

### A. IMU（加速度・姿勢）

* **生信号・座標系**

  * `acc_x/y/z`（端末座標）
  * 四元数 `rot_w/x/y/z` → 符号連続化・正規化 → **世界座標加速度** `world_acc_x/y/z`
  * **重力除去** `linear_acc_x/y/z`（LPF or median）
  * **角速度** `angular_vel_x/y/z`（四元数差分からの回転ベクトル/Δt）
  * **オイラー角** `euler_roll/pitch/yaw`（unwrapと円統計量：mean\_circ, R）

* **マグニチュード**

  * `acc_magnitude`, `world_acc_magnitude`, `linear_acc_magnitude`, `angular_vel_magnitude`

* **統計・変化**

  * `extract_statistical_features(...)` 一式（mean, std, var, min/max, median, 分位, IQR, range, first/last/delta, skew, kurt, 差分統計、3分割セグメント統計と遷移）
  * **ジャーク** `*_jerk_*`（|Δacc|/Δt：mean/std/max/p90/L2）
  * **角運動エネルギ** `angular_energy_*`（角速度²の平均の統計）

* **相関/ピーク/自己相関/勾配ヒスト/周波数/姿勢不変**

  * 相関：`corr_world_acc_xy/xz/yz`, `corr_linear_angular`
  * ピーク：`*_peak_count/mean_height/mean_distance/mean_distance_sec`
  * 自己相関：ラグ `[1,2,4,8]`
  * 勾配ヒスト：`*_grad_hist_bin0..9`（分位ベースbin）
  * 周波数（Welch）：バンドパワー `band_0.3_3/3_8/8_12` と相対/対数、`total_power`, `spectral_centroid/rolloff/entropy`, `dominant_freq`,（軸はZCRあり、マグニチュードはZCRなし）
  * 姿勢不変：`pose_vertical_horizontal_ratio`, `pose_tilt_angle_mean/std`
  * マルチスケール：`*_pyramid_(micro/short/medium)_{mean_mean,mean_std,std_mean,std_std}`
  * 末尾窓：`*_tail_mean/std/max/min`

> **系統まとめ（IMU）**：`acc_*`, `world_acc_*`, `linear_acc_*`, `angular_vel_*`, `euler_*`, `*_magnitude`, `*_jerk_*`, `angular_energy_*`, `corr_*`, `*_peak_*`, `*_autocorr_*`, `*_grad_hist_*`, `*_freq_*`, `pose_*`, `*_pyramid_*`, `*_tail_*`, `sequence_length`、および**Demographics**（`age/adult_child/sex/handedness/height_cm/shoulder_to_wrist_cm/elbow_to_wrist_cm`）

---

### B. ToF（Time-of-Flight）

* **モダリティ検出**：列名接頭辞（`tof`, `time_of_flight`, `tof_px`, `tof_dist`）で検出。`mod_present_tof`
* **フレーム集約（時系列）**：`tof_seq_mean/std/min/max/valid_ratio`（各時刻の有効画素のみ）
* **周辺統計/ピーク/自己相関/周波数**：`summarize_series_features(...)` により `tof_seq_*_freq_*` など時系列特徴を生成
* **空間特徴（8×8に復元できる場合）**：各時刻で

  * 重心 `cx, cy`
  * 2次中心モーメント `mu20, mu02, mu11`
  * 偏心率 `ecc`
  * 左右非対称 `lr_asym`、上下非対称 `ud_asym`
    → これらも `summarize_series_features` で時系列要約（統計/ピーク/自己相関/周波数）

> **系統まとめ（ToF）**：`mod_present_tof`, `tof_valid_ratio_mean`, `tof_seq_*`, `tof_seq_*_freq_*`, `tof_spatial_*`, `tof_spatial_*_freq_*`（空間復元できた場合）

---

### C. Thermal（サーマル/IR）

* **モダリティ検出**：接頭辞（`thermal`, `thm`, `temp`, `ir`）で検出。`mod_present_thm`
* **フレーム集約（時系列）**：`thm_seq_mean/std/min/max/valid_ratio`、ホットスポット比 `thm_seq_hotspot_ratio`
* **時系列要約**：統計/ピーク/自己相関/周波数（`thm_seq_*_freq_*`）

> **系統まとめ（Thermal）**：`mod_present_thm`, `thm_valid_ratio_mean`, `thm_seq_*`, `thm_seq_*_freq_*`

---

### D. クロスモダリティ（IMU×ToF/Thermal）

* 相関例：

  * `xmod_corr_linear_to_tofmin`（`linear_acc_mag` vs `tof_seq_min`）
  * `xmod_corr_omega_to_tofvalid`（`angular_vel_mag` vs `tof_seq_valid_ratio`）
  * `xmod_corr_linear_to_thmmean`（`linear_acc_mag` vs `thm_seq_mean`）

> **系統まとめ（XMOD）**：`xmod_*`

---

## 2) 実装の妥当性・堅牢性（動作レビュー）

**良い点（OK）**

* **IMUコア処理が体系的**（世界座標化、重力除去のLPF/medianフォールバック、四元数符号連続化、角速度推定、unwrap＋円統計）。
* **可変サンプリング周波数に対応**（`infer_dt_and_fs` で単位推定、5–200 Hzの妥当性チェック付き）。
* **ToF/Thermal** は「列名検出→フレーム集約→時系列要約→（ToFは空間特徴も）」という構造で**IMU非依存**に拡張されており、**IMUのみ/マルチモダリティの両方に対応**。
* **モダリティ・ドロップアウト**（学習時のみ）で、ToF/THMが無い環境でも精度劣化を抑える意図が明確（`xmod_` も該当モダリティを落とす設計）。
* **推論時の列合わせ**（`align_features_for_inference`）で、学習時カラム順・欠損に頑健。
* **foldごとの `classes_` を全18クラスへ展開**した加重アンサンブルは正しい（部分学習クラスがあっても位置合わせ可）。
* **短系列のフォールバック**や`filtfilt`失敗時のmedian処理など、例外に対する**防御的実装**が多い。

**IMUのみテストの可否**

* **推論**はOK：IMU列だけでも`extract_features`は動作し、ToF/THMは `mod_present_* = 0` として**追加のカラムは生成されない**→ ただし**推論側で trainingの`feature_names` に合わせて欠損列を0埋め**するため**問題なく動作**します。
* **学習**も基本OK：学習データ内にToF/THMあり/なしが混在しても、`pd.concat`で列和集合を取り、各サンプルの不足列はNaNになります（この点は後述の**改善必須**）。

---